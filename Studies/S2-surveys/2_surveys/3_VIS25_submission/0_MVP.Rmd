---
title: "MVP ANALYSES"
author: "ANONYMIZED"
date: "2024-02-24"
output:
  html_document:
    theme: cosmo
    code_folding: hide
    fig_caption: yes
    number_sections: no
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: yes
    toc_depth: 6
  pdf_document:
    toc: yes
    toc_depth: '5'
always_allow_html: yes
font-family: DejaVu Sans
mainfont: DejaVu Sans
editor_options: 
  markdown: 
    wrap: 72
---

# TODO 

# SETUP

### Import Packages

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#UTILITIES
library(Hmisc) # %nin% operator
library(psych) #describe() & efa
library(tidyverse) #all the things
library(magrittr) #special pipes like %<>%
library(summarytools) #data quality
library(lubridate) #dealing with dates
library(tinytable) ##sparkline tables 
library(webshot2) ##saving sparkline tables

#EDA
library(qacBase)

#VIZ
library(ggformula) #regression syntax viz
library(ggstatsplot) #dummies
library(gghalves) #half boxplots 
library(GGally) #extends ggplot for EDA 
library(corrplot) #sophisticated correlation plots
library(ggeasy) #easy labelling
library(ggh4x) #guides [dual axes]
library(patchwork) #multi-plot layout
library(ggdist) #raincloud plots and other distributionals
library(viridis) #color palettes
library(RColorBrewer) #color palettes
library(plotly) # interactive graphs
library(paletteer) #more palettes
library(interactions) ##easier regression ixn plots.srlsy
library(tidygraph)

#MODELLING
library(jtools) #Social Science regression utilities
library(easystats) #modelling helpers
library(see)
library(sjPlot)
library(lme4)
library(lmerTest) #for CIs in glmer
# library(mixed) ## utilities for glmers 
library(jmv) ## jamovi EFA


#STATISTICAL TESTS 
library(kSamples) #AD K-SAMPLE TEST (for distribution comparison)
library(rstatix) #FRIEDMAN'S TESTS and effect sizes 

#CONFIG
options(readr.show_col_types = FALSE) #don't show coltypes on read_csv
n_blocks = 6

## IMPORTANT 
GRAPH_SAVE = TRUE #set to true to generate all the SD graphs and save to folders 
source("graphing_functions.R") #import graphing palettes and custom functions

```

### Import References

```{r import-refs, message=FALSE, warning = FALSE}

############## IMPORT REFERENCE FILES
ref_stimuli <- readRDS("data/input/REFERENCE/ref_stimuli.rds")
ref_labels <- readRDS("data/input/REFERENCE/ref_labels.rds")


############## SETUP Graph Labels
ref_stim_id <- levels(ref_stimuli$ID)
ref_cat_questions <- c("MAKER_ID","MAKER_AGE","MAKER_GENDER")
ref_free_response <- c("MAKER_DETAIL", "MAKER_EXPLAIN", "TOOL_DETAIL", "CHART_EXPLAIN")
ref_conf_questions <- c("MAKER_CONF", "AGE_CONF", "GENDER_CONF", "TOOL_CONF")
ref_sd_questions <- rownames(ref_labels)
ref_blocks <- c(1,2,3,4,5,6)


############## FULL QUESTION SET FOR S1_3
ref_sd_questions <- c("MAKER_DESIGN","MAKER_DATA",
                      "MAKER_POLITIC", "MAKER_ARGUE","MAKER_SELF","MAKER_ALIGN","MAKER_TRUST",
                      "CHART_TRUST", "CHART_INTENT", "CHART_LIKE", "CHART_BEAUTY")

ref_sd_questions_z <- c("MAKER_DESIGN_z","MAKER_DATA_z",
                      "MAKER_POLITIC_z", "MAKER_ARGUE_z","MAKER_SELF_z","MAKER_ALIGN_z","MAKER_TRUST_z",
                      "CHART_TRUST_z", "CHART_INTENT_z", "CHART_LIKE_z", "CHART_BEAUTY_z")


############## MINIMAL QUESTION SET FOR Study 3
ref_labels_min <- readRDS("data/input/REFERENCE/ref_labels_S3.rds")
ref_min_sd_questions <-  c("DESIGN","DATA","POLITICS", "TRUST","ALIGN","BEAUTY","INTENT")
ref_min_sd_questions_z <-  c("DESIGN_z","DATA_z","POLITICS_z", "TRUST_z","ALIGN_z","BEAUTY_z","INTENT_z")



```

### Import Data

```{r import-data, message=FALSE, warning = FALSE}

############## IMPORT Study 1_3 DATA FILES
df_participants <- readRDS("data/output/Study_1_2/df_participants.rds") #1 row per participant â€” demographic
df_graphs <- readRDS("data/output/Study_1_2/df_graphs.rds") #only categorical and numeric questions
df_graphs_z <- readRDS("data/output/Study_1_2/df_graphs_z.rds") #only categorical and numeric questions
df_sd_questions_long <- readRDS("data/output/Study_1_2/df_sd_questions_long.rds") # only sd questions LONG
df_questions_long <- readRDS("data/output/Study_1_2/df_questions_long.rds") # includes categoricals 


############## IMPORT Study 3 DATA FILES



############## IMPORT COMBINED DATA FILES
df_graphs_all <- readRDS("data/output/COMBINED/df_graphs_ALL.rds") 
df_sd_questions_long_all <- readRDS("data/output/COMBINED/df_sd_questions_long_ALL.rds") # only sd questions LONG
```



# ANALYSES (Study 1, Study 2)

## (1) EFA | Exploratory Factor Analysis (S1,S2 minimal vars)

**As Reported in Section TODO, Figure TODO, here we conduct an exploratory factor analysis of the semantic differential scale questions.**

This analysis was performed on the combined dataset from Study 1 (Tumblr) and Study 2 (Prolific). Both studies were run on all 6 stimulus blocks, meaning the data are balanced across all stimuli. 

We use a parallel analysis method, verified by inspection of the scree plot to determine (f=4) factors, and see that both the KMO measure and Bartlett's test of sphericity meet the necessary pre-requisites to support this analysis.  The resultant factor loadings are described below.

```{r efa}

## SETUP DATA
df <- df_graphs_all %>% 
  filter(Study %in% c("Study1","Study2")) 
  # %>% filter(STIMULUS !="B0-0") ## filtering out B0-0 doesn't change factors
  
x <- ref_min_sd_questions_z
print("Dataset for EFA")
addmargins(table(df$Study, df$Assigned.Block)/5)


## RUN EFA JAMOVI STYLE
jmv::efa(
    data = df,
    vars = as.vector(x),
    # nFactors = 3,
    extraction = "ml",
    sortLoadings = FALSE,
    screePlot = TRUE,
    eigen = FALSE,
    factorCor = TRUE,
    factorSummary = TRUE,
    modelFit = TRUE,
    kmo = TRUE,
    bartlett = TRUE)


## RUN EFA PSYCH PACKAGE
# df <- df_graphs_all %>% select(all_of(ref_min_sd_questions_z))
# 
# # EFA using Maximum Likelihood extraction and Oblimin rotation
# efa_result <- fa(df, 
#                  nfactors = 3, 
#                  rotate = "oblimin", 
#                  fm = "ml")
# 
# # View the entire EFA output
# print(efa_result, cut = 0.3)
# # View entire result w/o cutoff
# # efa_result
# # Optional: visualize factor diagram
# fa.diagram(efa_result)

```


## (2) MODELLING | Predicting TRUST


## (0) DESCRIPTIVES | PLOTS

### [1] Semantic Differential Questions (Studies 1, 2 3(pre-post))

This plots the concicse set of semantic differential questions for BLOCK 1 stimuli for Study 1,2,3 faceting by pre/post on study 4, as a stacked ridgeplot

```{r plot_ridglines_sds_questions_stimulus_studies_block1_pre_post}
  
#### DENSITY RIDGES#############################################################################
#### loop over questions and stimuli, vertically stack studies, color by sample

## DEFINE DF
df <- df_sd_questions_long_all%>% 
  #only block 1 for balanced data
  filter(Assigned.Block==1) %>% 
  #drop pilot data
  filter(Study != "Study0") %>% 
  #for Study 3 ONLY, set SAMPLE = TIME (for graphing purpose)
  mutate(
    Sample = case_when(Study =="Study3" ~ TIME ,
                       .default = Sample)) %>% 
  mutate(Sample = factor(Sample, levels = c("TUMBLR","GENERAL","POST","PRE"))) %>% 
  droplevels()
  
  

## DEFINE REFS
n_q <- length(levels(df$QUESTION))
stimuli <- levels(df$STIMULUS)
questions <- ref_min_sd_questions #has qs in right order
labels <- ref_labels_min

## SET INITIAL VALUES
s <- stimuli[1]
q <- questions[1]
x = list() #list of plots

## LOOP OVER STIMULI, LOOP OVER QUESTIONS

for (s in stimuli){
  i=0
  # print(s)
  for (q in questions) {
    i = i+1
    # print(i)
    # print(q)
  
    ## FILTER Q AND CALCULATE MEDIAN
    d <- df %>% filter(STIMULUS ==s) %>% filter(QUESTION ==q) %>% 
    group_by(Study,Sample) %>% 
    mutate(m=median(value)) ## calc median for printing on graph
  
    x[[i]] <- 
      ggplot(d, aes(x = value, y = Study, fill = Sample, color = Sample, )) +
      geom_density_ridges2(scale = 1, panel_scaling = TRUE, rel_min_height = 0.01, alpha = 0.25,
          # ## POINT JITTER GEOMETRY
          # jittered_points = TRUE, alpha = 0.7, scale = 0.9)+
           # ## RUG GEOMETRY
            jittered_points = TRUE,
            position = position_points_jitter(width = 0.5, height = 0),
            point_shape = '|', point_size = 3, point_alpha = 0.5) +
      scale_x_continuous(limits=c(0,100)) +
      scale_fill_manual(values = my_palettes(name="simple_samples", direction = "1")) +
      scale_color_manual(values = my_palettes(name="simple_samples", direction = "1")) +
      ## MEDIAN
      stat_summary(fun=median, geom="text", fontface = "bold", size= 4,
                vjust=+2, hjust = 0.50, aes(label=round(m, digits=0)))+
      stat_summary(fun=median, geom="point", size=2) +
   
      labs (title = q, y = "", x = "") +
      guides(
        y = guide_axis_manual(labels = labels[q,"left"]),
        y.sec = guide_axis_manual(labels = labels[q,"right"]),
        # x.sec = guide_axis_manual(position = "top", title = q, breaks = NULL)
        ) +
      theme_ridges(grid = TRUE, center_axis_labels = TRUE) + easy_remove_legend() 
  
  }## END loop over questions

  ## JOIN QUESTION LEVEL PLOTS FOR THIS STIMULUS
  title <- ref_stimuli %>% filter(ID == s) %>% select(NAME)  ##TODO IF NOT WORK ref_stim_id
  title <- paste(s,"|",title)
  p <- x[[1]] / x[[2]] /x[[3]] / x[[4]] /x[[5]] / x[[6]] /x[[7]] 
  p <- p + plot_annotation(
     title = title,
     subtitle ="", caption = "(point is median)")

  ## SAVE GRAPH FOR THIS STIMULIS 
  if(GRAPH_SAVE == TRUE) {
     ggsave(plot = p, path="figs/MVP/FIG_Descriptives", filename =paste0("FULL_STUDY_STACK_",s,".png"), units = c("in"), width = 8, height = 24,  bg='#ffffff'  )}

}## END LOOP OVER STIMULI


```

### [2] Categorical Variables Plots (Study 1,2)

```{r maker-id-confidence}

df <- df_graphs %>% 
  #remove study pilot
  filter(Study!="Study0")

## D
## PROPORTIONAL BAR PLOT
## GGSTATSPLOT
##############################
#hack for consistent ordering of ggstats bar plot
dx <- df %>% mutate( MAKER_ID = fct_rev(MAKER_ID) )
S <-   ggbarstats( data = dx, x = MAKER_ID, y = Study,
                   legend.title = "MAKER ID",
                   label.args = list(alpha = 1, fill = "white", size=0), ## suppress the labels
                   results.subtitle	 = FALSE) + 
    scale_fill_manual(values = my_palettes(name="reds", direction = "1")) +
    theme_minimal() +
    labs( title = "MAKERID by Study",  x = "SAMPLE", y="PROPORTION") + 
    theme(aspect.ratio = 1)
##############################


## B
## x = Study, facet = stimulus 
# df <- df_questions_long %>% 
#   #filter block 1 only
#   filter(Assigned.Block==1) %>% 
#   #filter studies 1 & 2
#   filter(Study %in% c("Study1","Study2")) %>% 
#   #filter only maker id Q
#   filter(QUESTION=="MAKER_ID")

########################### BARPLOTS OF MAKER ID

## SETUP DATA 
 df <- df_graphs %>% 
  select(PID, Assigned.Block, Study, STIMULUS, ENCOUNTER, MAKER_ID, MAKER_AGE,MAKER_GENDER) %>% 
  filter(Study %in% c("Study1", "Study2")) %>%
  filter(Assigned.Block ==1) %>% 
  #reorder stimuli
  mutate(STIMULUS = factor(STIMULUS, levels=c("B1-1","B1-2","B1-3","B1-4","B0-0")))


######## FACETED BARPLOT MAKER
(ID <-  df %>% 
  ggplot(aes(x=Study, fill=MAKER_ID)) + 
    geom_bar(position="fill") + 
    scale_fill_manual(values = my_palettes(name="reds", direction = "1"))+
   facet_grid( .~ STIMULUS) + 
   coord_flip()
)
   
######## FACETED BARPLOT AGE
(AGE <- df %>% 
  ggplot(aes(x=Study, fill=MAKER_AGE)) + 
    geom_bar(position="fill") + 
    scale_fill_manual(values = my_palettes(name="lightblues", direction = "1"))+
   facet_grid( .~ STIMULUS) + 
   coord_flip()
) 
   
######## FACETED BARPLOT GENDER
(GENDER <-  df %>% 
  ggplot(aes(x=Study, fill=MAKER_GENDER)) + 
    geom_bar(position="fill") + 
    scale_fill_manual(values = my_palettes(name="smallgreens", direction = "1"))+
   facet_grid( .~ STIMULUS) + 
   coord_flip()
)   
   
######## FACETED BARPLOT ENCOUNTER
(ENCOUNTER <-  df %>% 
  ggplot(aes(x=Study, fill=ENCOUNTER)) + 
    geom_bar(position="fill") + 
    scale_fill_manual(values = my_palettes(name="encounter", direction = "1"))+
   facet_grid( .~ STIMULUS) + 
   coord_flip()
)



if(GRAPH_SAVE){
  
ggsave(plot = ID, path="figs/MVP/FIG_Descriptives", filename =paste0("MAKER_by_study.png"), units = c("in"), width = 12, height = 2 ,  bg='#ffffff'  )
  
ggsave(plot = AGE, path="figs/MVP/FIG_Descriptives", filename =paste0("AGE_by_study.png"), units = c("in"), width = 12, height = 2 ,  bg='#ffffff'  )
  
ggsave(plot = GENDER, path="figs/MVP/FIG_Descriptives", filename =paste0("GENDER_by_study.png"), units = c("in"), width = 12, height = 2 ,  bg='#ffffff'  )
  
ggsave(plot = ENCOUNTER, path="figs/MVP/FIG_Descriptives", filename =paste0("ENCOUNTER_by_study.png"), units = c("in"), width = 12, height = 2 ,  bg='#ffffff'  )
}


```




# SESSION

```{r session}
sessionInfo()
```
